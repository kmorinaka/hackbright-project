{% extends 'base.html' %}

{% block head %}

    <title>Search Results</title>

    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://code.jquery.com/jquery.js"></script>

 <script>   
    
    function initialize() {
        var map = new google.maps.Map(document.getElementById('map-results'), mapOptions)
        var businesses = {{ businesses|tojson|safe }}

        var mapOptions = {
              zoom: 12,
              center: new google.maps.LatLng(businesses[0].latitude, businesses[0].longitude)
            };

        map = new google.maps.Map(
            document.getElementById('map-results'),
            mapOptions);

        console.log('hello');
     

        for (var i=0; i < businesses.length; i++) {
            var myLatLng = new google.maps.LatLng(businesses[i].latitude, businesses[i].longitude);
            
            var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                title: businesses[i].name
             });
        }
        
    };

    google.maps.event.addDomListener(window, 'load', initialize);


    function createPhotoElement(photo) {
      var innerHtml = $('<img>')
        .addClass('instagram-image')
        .attr('src', photo.images.thumbnail.url);

      innerHtml = $('<a>')
        .attr('target', '_blank')
        .attr('href', photo.link)
        .append(innerHtml);

      return $('<div>')
        .addClass('instagram-placeholder')
        .attr('id', photo.id)
        .append(innerHtml);
    }

    function didLoadInstagram(event, response) {
      var that = this;

      $.each(response.data, function(i, photo) {
        $(that).append(createPhotoElement(photo));
      });
    }


    $(function() {
      $('.instagram').on('willLoadInstagram', function(event, options) {
        console.log(options);
      });


      $('.instagram').on('didLoadInstagram', didLoadInstagram);
      $('.instagram').instagram({
        search: {
          lat: "{{ businesses[0]['latitude'] }}",
          lng: "{{ businesses[0]['longitude'] }}",
          distance: '10',
          hash: '{{ term }}'
        },
        clientId: '{{ CLIENT_ID }}',
      });
    });

</script>
{% endblock %}


{% block content %}
<div class="container-fluid body">
   <h1>Results:</h1>
   <br>
   <p>Your search for <i>{{ term }}</i> returned {{ num_res }} results in <i>{{ location }}</i></p>
   <div class="row">
      <div class="business-info col-md-6">
        
            {% for business in businesses %}
              <div class="each-result">
               <a href='/details' class="savedata " data-name="{{ business['name'] }}" data-address="{{ business['address'] }}" data-city="{{ business['city'] }}" data-state="{{ business['state'] }}" data-zipcode="{{ business['zipcode'] }}" data-phone="{{ business['phone'] }}" data-categories="{{ business['categories'] }}" data-yelp-id="{{ business['id'] }}" data-yelp-url="{{ business['yelp_url'] }}" data-rating="{{ business['rating'] }}" data-url-rating-stars="{{ business['url_rating_stars'] }}" data-neighborhoods="{{ business['neighborhoods'] }}" data-cross-streets="{{ business['cross_streets'] }}" data-latitude="{{ business['latitude'] }}" data-longitude="{{ business['longitude'] }}">
               {{ business['name'] }}</a>
               <ul class="list-unstyled">
               <li>Address: {{ business['address'] }} {{ business['city'] }}, {{ business['state'] }} {{ business['zipcode'] }}</li>
               {% if business['phone'] %}
               <li>Phone number: {{ business['phone'] }}</li>
               {% else %}
               <li>Phone number: N/A</li>
               {% endif %} {% if business['categories'] %}
               <li>Categories: {{ business['categories'] }}</li>
               {% else %}
               <li>Categories: N/A</li>
               {% endif %} 
             </ul>
              </div>
            {% endfor %}
  
      </div>
      <div class="map-container col-md-6">
         <div id="map-results"></div>
      </div>
   </div>
   <div class="row">
      <div id="instafeed"></div>
      <div class="instagram"></div>
   </div>
</div>

<script>
    //make url safe version of all data attributes  ?address=45Miss&city=
        // use window.href to send a get request with all data attributes in the 

        // when they click on the business name, the function getDetails, gets the data from the data attributes
        $(".savedata").on("click", function(evt) {
            // prevents the routing href=/ on the <a>
            evt.preventDefault();
            // takes all the things on current target ('a') and turns it to a data object, setting that obj to variable params
            var params = $(evt.currentTarget).data();
            console.log(params)
            // .param() formats data object into parameter info
            var businessInfo = $.param(params);
            // debugging: console.log(businessInfo);
            // debugging: alert('clicked!');
            // pass the new formatted parameter info to the url attaching to '/details' route
            window.location.href = "/details?" + businessInfo;
        });
 
    </script>
    <!--
    add data- attribute for each key in business dictionary

    in javascript attach a click event to the span with id bname
    event handler for that click even will be a get request to the /profile route

    image for business

    display business info
    link to yelp
    map?

    -->
{% endblock %}